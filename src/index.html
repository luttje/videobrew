<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible"
        content="IE=edge">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0">
  <title>Animator</title>
</head>

<body class="flex flex-col gap-4 p-4 bg-white">
  <header>
    <h1 class="font-bold text-lg">Web Video Maker</h1>
    <p class="italic">
      Use Javascript to render something in this canvas. It will be turned into a video with FFMPEG.
    </p>
  </header>
  <main class="flex flex-col gap-4">
    <div>
      <canvas id="canvas"
              class="border border-gray-400"
              width="300"
              height="300">
      </canvas>
    </div>

    <input type="text"
           class="rounded border border-gray-400 p-2"
           placeholder="Framerate"
           id="framerateInput"
           value="30">

    <button id="recordStartButton"
      class="rounded bg-gray-700 text-white p-2">
      Start Recording
    </button>

    <button id="recordStopButton"
      class="rounded bg-gray-700 text-white p-2">
      Stop Recording
    </button>
  </main>

  <script type="module">
    import workerUrl from 'modern-screenshot/worker?url';
    import { createContext, destroyContext, domToBlob } from 'modern-screenshot';
    import * as videoBuilder from './index';
    import './index.css';

    const recordStartButton = document.getElementById('recordStartButton');
    const recordStopButton = document.getElementById('recordStopButton');
    const framerateInput = document.getElementById('framerateInput');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let context = null;
    let frames = [];

    recordStartButton.addEventListener('click', async () => {
      context = await createContext(document.body, {
        workerUrl,
        workerNumber: 1,
        type: 'image/jpeg',
      });
    });

    recordStopButton.addEventListener('click', async () => {
      destroyContext(context);
      context = null;
      const videoBlob = await videoBuilder.fromFrames(frames, framerateInput.value);
      const videoUrl = URL.createObjectURL(videoBlob);
      
      // Download video
      const a = document.createElement('a');
      document.body.appendChild(a);
      a.style.display = 'none';
      a.target = '_blank';
      a.href = videoUrl;
      a.click();
    });

    const radius = 20;
    const x = canvas.width / 2;
    let y = canvas.height - radius;

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      ctx.arc(x, y, radius, 0, Math.PI * 2);
      ctx.fillStyle = '#0095DD';
      ctx.fill();
      ctx.closePath();
    }

    let lastFrameTime = 0;
    let frameCount = 0;

    async function animate() {
      const now = performance.now();
      const elapsed = now - lastFrameTime;
      const framerate = parseInt(framerateInput.value, 10);
      const frameDuration = 1000 / framerate;

      if (elapsed > frameDuration) {
        lastFrameTime = now - (elapsed % frameDuration);
        draw();
        y -= 1;
        if (y < 0) {
          y = canvas.height;
        }

        if (context) {
          const frame = await domToBlob(context);
          frames.push(frame);
        }
      }
      
      requestAnimationFrame(animate);
    }

    animate();
  </script>
</body>

</html>